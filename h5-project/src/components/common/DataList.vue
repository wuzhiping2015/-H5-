<template>
  <div class="data-list">
    <!-- ÊêúÁ¥¢Ê†è -->
    <div v-if="searchable" class="data-list-search">
      <div class="search-input-wrapper">
        <input
          v-model="searchKeyword"
          type="text"
          class="search-input"
          :placeholder="searchPlaceholder"
          @input="handleSearch"
        />
        <span class="search-icon">üîç</span>
      </div>
    </div>
    
    <!-- Á≠õÈÄâÂô® -->
    <div v-if="filters && filters.length > 0" class="data-list-filters">
      <div class="filter-tags">
        <span
          v-for="filter in filters"
          :key="filter.value"
          :class="getFilterClass(filter)"
          @click="handleFilterClick(filter)"
        >
          {{ filter.label }}
        </span>
      </div>
    </div>
    
    <!-- ÂàóË°®ÂÆπÂô® -->
    <div
      ref="listContainerRef"
      class="data-list-container"
      @scroll="handleScroll"
    >
      <!-- ‰∏ãÊãâÂà∑Êñ∞ÊèêÁ§∫ -->
      <div v-if="refreshable && pullDownStatus" class="pull-down-tip">
        <div class="tip-content">
          <span class="tip-icon">{{ pullDownIcon }}</span>
          <span class="tip-text">{{ pullDownText }}</span>
        </div>
      </div>
      
      <!-- ÂàóË°®ÂÜÖÂÆπ -->
      <div class="data-list-content">
        <!-- ÊúâÊï∞ÊçÆÊó∂ÊòæÁ§∫ÂàóË°® -->
        <template v-if="displayList.length > 0">
          <div
            v-for="(item, index) in displayList"
            :key="getItemKey(item, index)"
            class="data-list-item"
            @click="handleItemClick(item, index)"
          >
            <slot name="item" :item="item" :index="index">
              <!-- ÈªòËÆ§ÂàóË°®È°π -->
              <div class="default-list-item">
                <div class="item-main">
                  <div class="item-title">{{ getItemTitle(item) }}</div>
                  <div class="item-description">{{ getItemDescription(item) }}</div>
                </div>
                <div class="item-extra">
                  <div class="item-value">{{ getItemValue(item) }}</div>
                  <div class="item-time">{{ getItemTime(item) }}</div>
                </div>
              </div>
            </slot>
          </div>
        </template>
        
        <!-- Á©∫Áä∂ÊÄÅ -->
        <div v-else-if="!loading && !initialLoading" class="data-list-empty">
          <slot name="empty">
            <div class="empty-content">
              <div class="empty-icon">üìù</div>
              <div class="empty-text">{{ emptyText }}</div>
              <button v-if="emptyButtonText" class="empty-button" @click="handleEmptyButtonClick">
                {{ emptyButtonText }}
              </button>
            </div>
          </slot>
        </div>
      </div>
      
      <!-- Â∫ïÈÉ®Âä†ËΩΩÊõ¥Â§ö -->
      <div v-if="loadMoreEnabled" class="data-list-footer">
        <div v-if="loadingMore" class="loading-more">
          <span class="loading-icon">‚è≥</span>
          <span class="loading-text">Âä†ËΩΩ‰∏≠...</span>
        </div>
        <div v-else-if="hasMore" class="load-more-button" @click="handleLoadMore">
          ÁÇπÂáªÂä†ËΩΩÊõ¥Â§ö
        </div>
        <div v-else-if="displayList.length > 0" class="no-more-data">
          Ê≤°ÊúâÊõ¥Â§öÊï∞ÊçÆ‰∫Ü
        </div>
      </div>
    </div>
    
    <!-- ÂÖ®Â±ÄÂä†ËΩΩÁä∂ÊÄÅ -->
    <div v-if="initialLoading" class="data-list-loading">
      <Loading :visible="true" text="Êï∞ÊçÆÂä†ËΩΩ‰∏≠..." />
    </div>
  </div>
</template>

<script setup>
/**
 * Êï∞ÊçÆÂàóË°®ÁªÑ‰ª∂
 * ÊîØÊåÅÊêúÁ¥¢„ÄÅÁ≠õÈÄâ„ÄÅ‰∏ãÊãâÂà∑Êñ∞„ÄÅ‰∏äÊãâÂä†ËΩΩÁ≠âÂäüËÉΩ
 * @author ÂâçÁ´ØÂ∑•Á®ãÂ∏àÂõ¢Èòü
 * @date 2024-12-XX
 */
import { ref, computed, watch, onMounted, onUnmounted } from 'vue'
import Loading from './Loading.vue'

// Props ÂÆö‰πâ
const props = defineProps({
  /** ÂàóË°®Êï∞ÊçÆ */
  data: {
    type: Array,
    default: () => []
  },
  /** ÊòØÂê¶ÂèØÊêúÁ¥¢ */
  searchable: {
    type: Boolean,
    default: false
  },
  /** ÊêúÁ¥¢Âç†‰ΩçÁ¨¶ */
  searchPlaceholder: {
    type: String,
    default: 'ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç'
  },
  /** ÊêúÁ¥¢Â≠óÊÆµ */
  searchFields: {
    type: Array,
    default: () => ['title', 'description']
  },
  /** Á≠õÈÄâÂô®ÈÖçÁΩÆ */
  filters: {
    type: Array,
    default: () => []
  },
  /** ÊòØÂê¶ÊîØÊåÅ‰∏ãÊãâÂà∑Êñ∞ */
  refreshable: {
    type: Boolean,
    default: false
  },
  /** ÊòØÂê¶ÊîØÊåÅÂä†ËΩΩÊõ¥Â§ö */
  loadMoreEnabled: {
    type: Boolean,
    default: false
  },
  /** ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ */
  hasMore: {
    type: Boolean,
    default: false
  },
  /** ÊòØÂê¶Ê≠£Âú®Âä†ËΩΩÊõ¥Â§ö */
  loadingMore: {
    type: Boolean,
    default: false
  },
  /** ÂàùÂßãÂä†ËΩΩÁä∂ÊÄÅ */
  loading: {
    type: Boolean,
    default: false
  },
  /** Á©∫Áä∂ÊÄÅÊñáÊú¨ */
  emptyText: {
    type: String,
    default: 'ÊöÇÊó†Êï∞ÊçÆ'
  },
  /** Á©∫Áä∂ÊÄÅÊåâÈíÆÊñáÊú¨ */
  emptyButtonText: {
    type: String,
    default: ''
  },
  /** ÂàóË°®È°πÈîÆÂÄºÂ≠óÊÆµ */
  itemKey: {
    type: String,
    default: 'id'
  }
})

// Events ÂÆö‰πâ
const emit = defineEmits([
  'search',
  'filter-change',
  'item-click',
  'refresh',
  'load-more',
  'empty-button-click'
])

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const searchKeyword = ref('')
const activeFilter = ref(null)
const listContainerRef = ref(null)
const pullDownStatus = ref(false)
const pullDownDistance = ref(0)
const initialLoading = ref(props.loading)

// ‰∏ãÊãâÂà∑Êñ∞Áõ∏ÂÖ≥
const pullDownIcon = computed(() => {
  if (pullDownDistance.value > 80) return '‚Üª'
  return '‚Üì'
})

const pullDownText = computed(() => {
  if (pullDownDistance.value > 80) return 'ÈáäÊîæÂà∑Êñ∞'
  return '‰∏ãÊãâÂà∑Êñ∞'
})

/**
 * Á≠õÈÄâÂêéÁöÑÂàóË°®Êï∞ÊçÆ
 */
const displayList = computed(() => {
  let result = [...props.data]
  
  // Â∫îÁî®Á≠õÈÄâÂô®
  if (activeFilter.value) {
    result = result.filter(item => {
      if (typeof activeFilter.value.filter === 'function') {
        return activeFilter.value.filter(item)
      }
      return true
    })
  }
  
  // Â∫îÁî®ÊêúÁ¥¢
  if (searchKeyword.value.trim()) {
    const keyword = searchKeyword.value.toLowerCase()
    result = result.filter(item => {
      return props.searchFields.some(field => {
        const value = item[field]
        return value && value.toString().toLowerCase().includes(keyword)
      })
    })
  }
  
  return result
})

/**
 * Ëé∑ÂèñÁ≠õÈÄâÂô®Ê†∑ÂºèÁ±ª
 * @param {Object} filter Á≠õÈÄâÂô®ÂØπË±°
 */
const getFilterClass = (filter) => {
  return [
    'filter-tag',
    {
      'filter-tag--active': activeFilter.value?.value === filter.value
    }
  ]
}

/**
 * Ëé∑ÂèñÂàóË°®È°πÂîØ‰∏ÄÈîÆ
 * @param {Object} item ÂàóË°®È°π
 * @param {number} index Á¥¢Âºï
 */
const getItemKey = (item, index) => {
  return item[props.itemKey] || index
}

/**
 * Ëé∑ÂèñÂàóË°®È°πÊ†áÈ¢ò
 * @param {Object} item ÂàóË°®È°π
 */
const getItemTitle = (item) => {
  return item.title || item.name || ''
}

/**
 * Ëé∑ÂèñÂàóË°®È°πÊèèËø∞
 * @param {Object} item ÂàóË°®È°π
 */
const getItemDescription = (item) => {
  return item.description || item.subtitle || ''
}

/**
 * Ëé∑ÂèñÂàóË°®È°πÂÄº
 * @param {Object} item ÂàóË°®È°π
 */
const getItemValue = (item) => {
  return item.value || item.amount || ''
}

/**
 * Ëé∑ÂèñÂàóË°®È°πÊó∂Èó¥
 * @param {Object} item ÂàóË°®È°π
 */
const getItemTime = (item) => {
  if (item.time) return item.time
  if (item.createTime) return item.createTime
  if (item.updatedAt) return item.updatedAt
  return ''
}

/**
 * Â§ÑÁêÜÊêúÁ¥¢
 */
const handleSearch = () => {
  emit('search', searchKeyword.value)
}

/**
 * Â§ÑÁêÜÁ≠õÈÄâÂô®ÁÇπÂáª
 * @param {Object} filter Á≠õÈÄâÂô®ÂØπË±°
 */
const handleFilterClick = (filter) => {
  if (activeFilter.value?.value === filter.value) {
    activeFilter.value = null
  } else {
    activeFilter.value = filter
  }
  emit('filter-change', activeFilter.value)
}

/**
 * Â§ÑÁêÜÂàóË°®È°πÁÇπÂáª
 * @param {Object} item ÂàóË°®È°π
 * @param {number} index Á¥¢Âºï
 */
const handleItemClick = (item, index) => {
  emit('item-click', item, index)
}

/**
 * Â§ÑÁêÜÊªöÂä®‰∫ã‰ª∂
 * @param {Event} event ÊªöÂä®‰∫ã‰ª∂
 */
const handleScroll = (event) => {
  const { scrollTop, scrollHeight, clientHeight } = event.target
  
  // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂ∫ïÈÉ®ÔºåËß¶ÂèëÂä†ËΩΩÊõ¥Â§ö
  if (props.loadMoreEnabled && props.hasMore && !props.loadingMore) {
    if (scrollTop + clientHeight >= scrollHeight - 100) {
      handleLoadMore()
    }
  }
}

/**
 * Â§ÑÁêÜ‰∏ãÊãâÂà∑Êñ∞
 */
const handleRefresh = () => {
  if (props.refreshable) {
    emit('refresh')
  }
}

/**
 * Â§ÑÁêÜÂä†ËΩΩÊõ¥Â§ö
 */
const handleLoadMore = () => {
  if (props.loadMoreEnabled && props.hasMore && !props.loadingMore) {
    emit('load-more')
  }
}

/**
 * Â§ÑÁêÜÁ©∫Áä∂ÊÄÅÊåâÈíÆÁÇπÂáª
 */
const handleEmptyButtonClick = () => {
  emit('empty-button-click')
}

// ÁõëÂê¨Âä†ËΩΩÁä∂ÊÄÅÂèòÂåñ
watch(() => props.loading, (newVal) => {
  if (!newVal) {
    initialLoading.value = false
  }
})

// ÁªÑ‰ª∂ÊåÇËΩΩ
onMounted(() => {
  // ÂèØ‰ª•Âú®ËøôÈáåÂàùÂßãÂåñ‰∏ãÊãâÂà∑Êñ∞Á≠âÂäüËÉΩ
})

onUnmounted(() => {
  // Ê∏ÖÁêÜÂ∑•‰Ωú
})
</script>

<style lang="scss" scoped>
@use "@/assets/styles/variables.scss" as *;
@use "@/assets/styles/mixins.scss" as *;
.data-list {
  position: relative;
  height: 100%;
  display: flex;
  flex-direction: column;
}

// ÊêúÁ¥¢Ê†è
.data-list-search {
  padding: $spacing-base;
  background-color: $background-color;
  border-bottom: 1px solid $border-color-light;
  
  .search-input-wrapper {
    position: relative;
    
    .search-input {
      width: 100%;
      padding: $spacing-sm $spacing-base;
      padding-right: 40px;
      border: 1px solid $border-color;
      border-radius: $border-radius-lg;
      background-color: $background-color-light;
      font-size: $font-size-base;
      outline: none;
      @include transition(border-color);
      
      &:focus {
        border-color: $primary-color;
      }
      
      &::placeholder {
        color: $text-color-disabled;
      }
    }
    
    .search-icon {
      position: absolute;
      right: $spacing-base;
      top: 50%;
      transform: translateY(-50%);
      color: $text-color-disabled;
    }
  }
}

// Á≠õÈÄâÂô®
.data-list-filters {
  padding: $spacing-base;
  background-color: $background-color;
  border-bottom: 1px solid $border-color-light;
  
  .filter-tags {
    display: flex;
    gap: $spacing-sm;
    flex-wrap: wrap;
  }
  
  .filter-tag {
    padding: $spacing-xs $spacing-sm;
    border: 1px solid $border-color;
    border-radius: $border-radius-base;
    font-size: $font-size-sm;
    color: $text-color-secondary;
    cursor: pointer;
    @include transition(all);
    
    &:hover {
      border-color: $primary-color;
      color: $primary-color;
    }
    
    &--active {
      background-color: $primary-color;
      border-color: $primary-color;
      color: white;
    }
  }
}

// ÂàóË°®ÂÆπÂô®
.data-list-container {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

// ‰∏ãÊãâÂà∑Êñ∞ÊèêÁ§∫
.pull-down-tip {
  padding: $spacing-base;
  text-align: center;
  background-color: $background-color-light;
  
  .tip-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: $spacing-xs;
    color: $text-color-secondary;
    font-size: $font-size-sm;
  }
}

// ÂàóË°®ÂÜÖÂÆπ
.data-list-content {
  min-height: 100%;
}

// ÂàóË°®È°π
.data-list-item {
  padding: $spacing-base;
  border-bottom: 1px solid $border-color-light;
  cursor: pointer;
  @include transition(background-color);
  
  &:hover {
    background-color: $background-color-light;
  }
  
  &:last-child {
    border-bottom: none;
  }
}

// ÈªòËÆ§ÂàóË°®È°πÊ†∑Âºè
.default-list-item {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: $spacing-base;
  
  .item-main {
    flex: 1;
    min-width: 0;
  }
  
  .item-title {
    font-size: $font-size-base;
    font-weight: $font-weight-medium;
    color: $text-color-primary;
    margin-bottom: $spacing-xs;
    @include text-ellipsis();
  }
  
  .item-description {
    font-size: $font-size-sm;
    color: $text-color-secondary;
    @include text-ellipsis();
  }
  
  .item-extra {
    flex-shrink: 0;
    text-align: right;
  }
  
  .item-value {
    font-size: $font-size-base;
    font-weight: $font-weight-medium;
    color: $text-color-primary;
    margin-bottom: $spacing-xs;
  }
  
  .item-time {
    font-size: $font-size-sm;
    color: $text-color-disabled;
  }
}

// Á©∫Áä∂ÊÄÅ
.data-list-empty {
  @include center;
  padding: $spacing-xxl $spacing-base;
  
  .empty-content {
    text-align: center;
    max-width: 240px;
  }
  
  .empty-icon {
    font-size: 48px;
    margin-bottom: $spacing-base;
    opacity: 0.5;
  }
  
  .empty-text {
    font-size: $font-size-base;
    color: $text-color-disabled;
    margin-bottom: $spacing-base;
  }
  
  .empty-button {
    @include button-base($primary-color, white);
    padding: $spacing-sm $spacing-base;
  }
}

// Â∫ïÈÉ®Âä†ËΩΩ
.data-list-footer {
  padding: $spacing-base;
  text-align: center;
  
  .loading-more {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: $spacing-xs;
    color: $text-color-secondary;
    font-size: $font-size-sm;
  }
  
  .load-more-button {
    padding: $spacing-sm $spacing-base;
    color: $primary-color;
    cursor: pointer;
    @include transition(color);
    
    &:hover {
      color: $primary-dark;
    }
  }
  
  .no-more-data {
    font-size: $font-size-sm;
    color: $text-color-disabled;
  }
}

// ÂÖ®Â±ÄÂä†ËΩΩ
.data-list-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

// ÁßªÂä®Á´ØÈÄÇÈÖç
@include respond-to(xs) {
  .data-list-search,
  .data-list-filters {
    padding: $spacing-sm $spacing-base;
  }
  
  .data-list-item {
    padding: $spacing-sm $spacing-base;
  }
  
  .default-list-item {
    gap: $spacing-sm;
  }
  
  .empty-icon {
    font-size: 40px;
  }
}
</style>